const socket={io:null,connected:!1,registered:!1},input={keys:{},mouse:{}},game={loading:!0,loadMessage:"Starting...",isTyping:!1,typedString:"",typeLengthLimit:0,error:"",errorAnim:-1,inGame:!1,gameData:{},localData:{},playerData:{},mainMenuAnim:0,menu:menus.main,menuButtonAnims:[],menuAnim:0,matchAnim:0,boardOrigin:[0,0],boardTranslation:[0,0],boardRotation:0,boardScale:0,boardNotifications:[],awaitingKeypress:!1,keypressToChange:""},state={creatingNewAccount:!1,loadingData:!1,joiningMatch:!1,inSettings:!1},images={nathan:null,small:null};let SQUARE_SIZE=0;const controls={left:37,right:39,down:40,drop:" ".charCodeAt(0),rotateRight:38,rotateLeft:"Z".charCodeAt(0),rotate180:"X".charCodeAt(0),hold:"C".charCodeAt(0)};let settings=null;const defaultSettings={moveSpeed:2,"controls.left":37,"controls.right":39,"controls.down":40,"controls.drop":" ".charCodeAt(0),"controls.rotateRight":38,"controls.rotateLeft":"Z".charCodeAt(0),"controls.rotate180":"A".charCodeAt(0),"controls.hold":"C".charCodeAt(0)},ON_OR_OFF=[{key:"on",value:!0},{key:"off",value:!1}];function resetState(){for(let e in state)state[e]=!1;game.inGame=!1,game.loading=!1,game.loadMessage="",game.isTyping=!1,game.typedString="",game.typeLengthLimit=0,game.error="",game.errorAnim=-1,game.inGame=!1,game.gameData={},game.localData={},game.playerData={},game.mainMenuAnim=0,game.menu=menus.main,game.menuButtonAnims=[],game.menuAnim=0,game.matchAnim=0,game.boardOrigin=[width/2,-height/2],game.boardTranslation=[0,0],game.boardRotation=0,game.boardScale=1,game.boardNotifications=[],game.awaitingKeypress=!1,game.keypressToChange=""}function preload(){images.nathan=loadImage("./assets/nathan.png"),images.small=loadImage("./assets/nathan32.png")}function setup(){createCanvas(),windowResized(),loadRankIcons(),reset(),connect()}function reset(){background(250),game.loading=!0,game.loadMessage="Starting...",socket.io=null,socket.connected=!1,socket.registered=!1,loadSettings(),resetState()}function resetSettings(){settings=null,localStorage.removeItem("chentris_2_settings"),loadSettings()}function getSetting(e){return settings[e]?settings[e]:(settings[e]=defaultSettings[e],saveSettings(),defaultSettings[e])}function setSetting(e,t){settings[e]=t,saveSettings()}function loadSettings(){localStorage.getItem("chentris_2_settings")?settings=JSON.parse(localStorage.getItem("chentris_2_settings")):(saveSettings(),loadSettings())}function saveSettings(){localStorage.setItem("chentris_2_settings",JSON.stringify(settings||defaultSettings))}function getId(){return localStorage.getItem("chentris_2_id")}function setId(e){return localStorage.setItem("chentris_2_id",e||"null")}function loadData(){resetState(),game.loading=!0,game.loadMessage="Loading player...",state.loadingData=!0,socket.io.emit("player_data")}function connect(){socket.io=io({path:"/chentris2/socket.io",query:{id:getId(),forceNew:!0}}),socket.connected=!0,game.loading=!0,game.loadMessage="Connecting...",socket.io.on("connect",(()=>{game.loading=!0,game.loadMessage="Registering..."})),socket.io.on("register",(e=>{e.registered?(socket.registered=!0,loadData()):"INVALID_ID"===e.error?(game.error="The id is invalid. If the issue persists, clear your local storage.",game.errorAnim=99999):"NULL_ID"!==e.error&&"INVALID_USERNAME"!==e.error||(game.loading=!1,game.loadMessage="",game.isTyping=!0,game.typedString="",game.typeLengthLimit=16,state.creatingNewAccount=!0,"INVALID_USERNAME"===e.error&&(game.error="Your username is invalid.",game.errorAnim=5))})),socket.io.on("set_id",(e=>{setId(e.id)})),socket.io.on("player_data",(e=>{game.loading=!1,game.loadMessage="",game.playerData=e.user,e.inGame||(game.mainMenuAnim=1,switchMenu("main"),window.location.hash.length>=1&&(10===window.location.hash.length?joinMatch(window.location.hash.substring(1)):(game.error="Invalid match link.",game.errorAnim=5)))})),socket.io.on("error",(e=>{game.errorAnim=5,game.error=`Fatal packet error type <${e.type}>: ${e.error}. Reloading in 5 seconds.`,setTimeout((()=>{reset(),connect()}),5e3)})),socket.io.on("match_found",(e=>{if(game.loading=!1,game.loadMessage="",window.location.hash="",e.error)return game.error=e.message,void(game.errorAnim=5);game.inGame=!0;const t=deepCopyBoard(e.match.boards[game.playerData._id]);game.gameData={match:e.match,moves:[]},game.matchAnim=1,game.boardOrigin=[width/2,-height/2],game.boardTranslation=[0,0],game.boardRotation=0,game.boardScale=1,game.boardNotifications=[],game.localData={board:t,state:defaultSubmoveState(),stateAcc:0,speed:80,timers:{fall:0,dropping:!1,shortDrop:0,longDrop:0},deadAnim:0,boardAnims:{},boardSizes:{},ready:!1,attackOption:0}})),socket.io.on("board_reset",(()=>{const e=deepCopyBoard(game.gameData.match.boards[game.playerData._id]);game.boardOrigin=[width/2,-height/2],game.boardTranslation=[0,0],game.boardRotation=0,game.boardScale=1,game.gameData={match:game.gameData.match,moves:[]},game.localData={board:e,state:defaultSubmoveState(),stateAcc:0,speed:80,timers:{fall:0,dropping:!1,shortDrop:0,longDrop:0},deadAnim:0,boardAnims:{},boardSizes:{},ready:!1,attackOption:0},game.localData.board.move=0})),socket.io.on("match_state",(e=>{if(!game.inGame)return;const t=e.match.boards[game.playerData._id],a=game.localData.board.move;game.gameData={match:e.match,moves:game.gameData.moves.filter((e=>e.num>=t.move))},game.localData.board=t;for(let e of game.gameData.moves)game.localData.board=makeMove(e.move,game.localData.board,Math.seedrandom,game.gameData.match.rules);game.localData.board.move=a,game.gameData.match.newNotification&&game.boardNotifications.push({text:game.gameData.match.notification,time:0})}))}function joinMatch(e){socket.io.emit("join_match",{code:e}),game.loading=!0,game.loadMessage="Joining..."}function windowResized(){resizeCanvas(windowWidth,windowHeight),SQUARE_SIZE=(height-200)/20}function keyTyped(){game.isTyping&&game.typedString.length<game.typeLengthLimit&&"Enter"!==key&&(game.typedString+=key)}function keyPressed(){game.awaitingKeypress&&(keyCode!==ESCAPE&&setSetting(game.keypressToChange,keyCode),game.awaitingKeypress=!1,game.keypressToChange=""),keyCode===BACKSPACE&&game.isTyping&&game.typedString.length>0&&(game.typedString=game.typedString.substring(0,game.typedString.length-1)),input.keys[keyCode]=0}function keyReleased(){input.keys[keyCode]=-1}function mousePressed(){input.mouse[mouseButton]=0}function mouseReleased(){input.mouse[mouseButton]=-1}function updateInput(){for(let e in input.keys)input.keys[e]>=0&&(input.keys[e]+=1);for(let e in input.mouse)input.mouse[e]>=0&&(input.mouse[e]+=1)}function clamp(e,t,a){return min(max(e,t),a)}function update(){const e=frameRate()>0?1/frameRate():0;if(game.errorAnim>0&&(game.errorAnim-=e),state.creatingNewAccount&&0===input.keys["\r".charCodeAt(0)]){const o=game.typedString.trim().substring(0,32);o.length>0&&(socket.io.emit("create_account",{username:o}),game.loading=!0,game.loadMessage="Registering...",game.creatingNewAccount=!1)}if(socket.registered&&(game.mainMenuAnim=lerp(game.mainMenuAnim,0,clamp(6*e,0,1)),game.menuAnim=lerp(game.menuAnim,0,clamp(6*e,0,1)),game.matchAnim=lerp(game.matchAnim,0,clamp(6*e,0,1)),!game.inGame))if(state.joiningMatch){const l=/[^0-9]/g;game.typedString=game.typedString.replace(l,"");const n=()=>{state.joiningMatch=!1,game.isTyping=!1,game.typedString="",game.typeLengthLimit=0};buttonState(width/2+160,height/2-50,40,20,(()=>{}),n),0===input.keys[ESCAPE]&&n(),9===game.typedString.length&&(joinMatch(game.typedString),game.isTyping=!1,game.typedString="",game.typeLengthLimit=-1,state.joiningMatch=!1)}else if(state.inSettings){const r=()=>{state.inSettings=!1};function t(e){game.awaitingKeypress=!0,game.keypressToChange=e}buttonState(width/2+460,height/2-300,40,20,(()=>{}),r),0===input.keys[ESCAPE]&&r(),buttonState(width/2+140,height/2-250,100,20,(()=>{}),(()=>t("controls.left"))),buttonState(width/2+140,height/2-220,100,20,(()=>{}),(()=>t("controls.right"))),buttonState(width/2+140,height/2-190,100,20,(()=>{}),(()=>t("controls.down"))),buttonState(width/2+140,height/2-160,100,20,(()=>{}),(()=>t("controls.drop"))),buttonState(width/2+140,height/2-130,100,20,(()=>{}),(()=>t("controls.rotateLeft"))),buttonState(width/2+140,height/2-100,100,20,(()=>{}),(()=>t("controls.rotateRight"))),buttonState(width/2+140,height/2-70,100,20,(()=>{}),(()=>t("controls.rotate180"))),buttonState(width/2+140,height/2-40,100,20,(()=>{}),(()=>t("controls.hold"))),buttonState(width/2+340,height/2+260,150,30,(()=>{}),(()=>resetSettings()))}else for(let g=0;g<game.menu.length;g++){const m=mouseX<300&&mouseY>100+50*g&&mouseY<140+50*g;game.menuButtonAnims[g]=lerp(game.menuButtonAnims[g],m?1:0,clamp(30*e,0,1)),0===input.mouse[LEFT]&&m&&game.menu[g].onClick()}if(game.inGame){if(0===input.keys["\r".charCodeAt(0)]&&(game.gameData.match.playing||(game.localData.ready=!game.localData.ready,socket.io.emit("ready",{ready:game.localData.ready}))),buttonState(20,95,180,30,(()=>{}),(()=>navigator.clipboard.writeText(`https://play.hked.live/chentris2#${game.gameData.match.joinCode}`)),!game.gameData.match.options.allowJoining),buttonState(20,130,180,30,(()=>{}),(()=>{socket.io.emit("leave_match"),reset(),connect()}),!1),!game.inGame)return;function a(e,t){const a={...game.gameData.match.options};a[e]=t,socket.io.emit("match_options",{options:a})}function i(e,t){const a={...game.gameData.match.rules};a[e]=t,socket.io.emit("match_options",{rules:a})}selectState(150,200,40,20,ON_OR_OFF,(()=>game.gameData.match.options.allowJoining),(e=>a("allowJoining",e)),!1),selectState(150,225,40,20,ON_OR_OFF,(()=>game.gameData.match.options.public),(e=>a("public",e)),!1),selectState(150,250,40,20,ON_OR_OFF,(()=>game.gameData.match.options.ranked),(e=>a("ranked",e)),!1);const s=game.gameData.match.rules.competitive;if(selectState(150,325,40,20,ON_OR_OFF,(()=>s),(e=>i("competitive",e)),!1),selectState(150,350,40,20,[{key:"slow",value:80},{key:"medium",value:160},{key:"fast",value:320},{key:"very fast",value:640}],(()=>game.gameData.match.rules.initialSpeed),(e=>i("initialSpeed",e)),s),selectState(150,375,40,20,ON_OR_OFF,(()=>game.gameData.match.rules.resendGarbage),(e=>i("resendGarbage",e)),s),selectState(150,400,40,20,ON_OR_OFF,(()=>game.gameData.match.rules.forgivingCombos),(e=>i("forgivingCombos",e)),s),selectState(150,425,40,20,[{key:"one",value:1},{key:"two",value:2},{key:"three",value:3}],(()=>game.gameData.match.rules.garbageTurns),(e=>i("garbageTurns",e)),s),selectState(150,450,40,20,ON_OR_OFF,(()=>game.gameData.match.rules.garbageDefense),(e=>i("garbageDefense",e)),s),!game.inGame)return;for(let u of game.boardNotifications)u.time+=e;game.boardNotifications=game.boardNotifications.filter((e=>e.time<=1));let c={x:0,y:0};c=!game.gameData.match.playing||game.gameData.match.players.filter((e=>!game.gameData.match.boards[e].lost)).length<=1?{x:width/2,y:height/2}:{x:13*SQUARE_SIZE,y:height/2},game.boardOrigin[0]=lerp(game.boardOrigin[0],c.x,clamp(6*e,0,1)),game.boardOrigin[1]=lerp(game.boardOrigin[1],c.y,clamp(6*e,0,1)),game.boardTranslation[0]=lerp(game.boardTranslation[0],0,clamp(6*e,0,1)),game.boardTranslation[1]=lerp(game.boardTranslation[1],0,clamp(6*e,0,1)),game.boardRotation=lerp(game.boardRotation,0,clamp(6*e,0,1)),game.boardScale=lerp(game.boardScale,1,clamp(6*e,0,1)),game.localData.timers.fall+=e,game.localData.stateAcc+=e,game.localData.board.lost?game.localData.deadAnim+=e:game.localData.deadAnim=lerp(game.localData.deadAnim,0,clamp(30*e,0,1)),game.localData.stateAcc>.05&&(game.localData.stateAcc=0,socket.io.emit("submove_state",{state:game.localData.state,timers:game.localData.timers,attackOption:game.localData.attackOption})),game.localData.timers.dropping&&(game.localData.timers.shortDrop+=e*(input.keys[settings["controls.down"]]>=0?4:1),game.localData.timers.longDrop+=e);let d=null;0===input.keys[settings["controls.hold"]]&&(d={type:"hold"},game.localData.board.canHold&&(game.localData.state=defaultSubmoveState()));const h=60/game.localData.speed;if(input.keys[settings["controls.down"]]%settings.moveSpeed==0||game.localData.timers.fall>=h){game.localData.state=makeSubmove("down",game.localData.board,game.localData.state);let f=!0;for(;game.localData.timers.fall>=h;)f||(game.localData.state=makeSubmove("down",game.localData.board,game.localData.state)),f=!1,game.localData.timers.fall-=h}input.keys[settings["controls.left"]]%settings.moveSpeed==0&&(0===input.keys[settings["controls.left"]]||input.keys[settings["controls.left"]]>2*settings.moveSpeed)&&(game.localData.state=makeSubmove("left",game.localData.board,game.localData.state),game.localData.state.lastMoveSuccessful&&(game.localData.timers.shortDrop=0,game.boardTranslation[0]-=2,game.boardRotation-=.002)),input.keys[settings["controls.right"]]%settings.moveSpeed==0&&(0===input.keys[settings["controls.right"]]||input.keys[settings["controls.right"]]>2*settings.moveSpeed)&&(game.localData.state=makeSubmove("right",game.localData.board,game.localData.state),game.localData.state.lastMoveSuccessful&&(game.localData.timers.shortDrop=0,game.boardTranslation[0]+=2,game.boardRotation+=.002)),0===input.keys[settings["controls.rotateRight"]]&&(game.localData.state=makeSubmove("rotateRight",game.localData.board,game.localData.state),game.localData.state.lastMoveSuccessful&&(game.localData.timers.shortDrop=0,game.boardRotation+=.001)),0===input.keys[settings["controls.rotateLeft"]]&&(game.localData.state=makeSubmove("rotateLeft",game.localData.board,game.localData.state),game.localData.state.lastMoveSuccessful&&(game.localData.timers.shortDrop=0,game.boardRotation-=.001));for(let p=0;p<5;p+=1)0===input.keys[(p+1).toString().charCodeAt(0)]&&(game.localData.attackOption=p);if(0===input.keys[settings["controls.rotate180"]]&&(game.localData.state=makeSubmove("rotate180",game.localData.board,game.localData.state),game.localData.state.lastMoveSuccessful&&(game.localData.timers.shortDrop=0,game.boardRotation-=.002)),game.localData.timers.dropping=game.localData.state.pieceY===makeSubmove("drop",game.localData.board,game.localData.state).pieceY,(0===input.keys[settings["controls.drop"]]||game.localData.timers.shortDrop>=max(.5,120/game.localData.speed)||game.localData.timers.longDrop>=max(2,640/game.localData.speed))&&(0===input.keys[settings["controls.drop"]]&&(game.localData.state=makeSubmove("drop",game.localData.board,game.localData.state),game.boardTranslation[1]+=10),d={type:"move",submoves:game.localData.state.submoves},game.localData.timers={fall:0,dropping:!1,shortDrop:0,longDrop:0},game.localData.state=defaultSubmoveState()),d){if(game.localData.board=makeMove(d,game.localData.board,Math.seedrandom,game.gameData.match.rules),socket.io.emit("move",{move:d,time:Date.now()}),game.localData.board.clears>0){const S=game.localData.board.clears,D=S**2;game.boardRotation+=.1*S,game.boardScale+=.02*D}game.gameData.moves.push({move:d,num:game.localData.board.move}),game.localData.board.move+=1}if(game.gameData.match.playing){let x=0;const y=game.gameData.match.players.filter((e=>!game.gameData.match.boards[e].lost)).length,w=y<=2?SQUARE_SIZE:(height-150)/ceil(sqrt(y))/24;let b=game.gameData.match.boards[game.playerData._id].lost;for(let k of game.gameData.match.players.filter((e=>e!==game.playerData._id))){const A=getIdealPos(x,y-1,width-200-17*SQUARE_SIZE,height-200);A[0]+=17*SQUARE_SIZE+100,A[1]+=100;const v=b&&!game.gameData.match.boards[k].lost;if(v&&(A[0]=game.boardOrigin[0],A[1]=game.boardOrigin[1]),game.localData.boardAnims[k]||(game.localData.boardAnims[k]=[],game.localData.boardAnims[k][0]=A[0],game.localData.boardAnims[k][1]=A[1],game.localData.boardAnims[k][2]=0,game.localData.boardSizes[k]=0),game.localData.boardAnims[k][0]=lerp(game.localData.boardAnims[k][0],A[0],clamp(6*e,0,1)),game.localData.boardAnims[k][1]=lerp(game.localData.boardAnims[k][1],A[1],clamp(6*e,0,1)),game.localData.boardSizes[k]=lerp(game.localData.boardSizes[k],v?SQUARE_SIZE:w,clamp(3*e,0,1)),game.gameData.match.boards[k].lost){const O=50*game.localData.boardAnims[k][2],E=O**2-20*O,R=-O*log(O+1);game.localData.boardAnims[k][0]=A[0]+R,game.localData.boardAnims[k][1]=A[1]+E,game.localData.boardAnims[k][2]+=e}else v||(x+=1);v&&(b=!1)}}}}function buttonState(e,t,a,i,o,l,n=!1){n||mouseX>e&&mouseY>t&&mouseX<e+a&&mouseY<t+i&&(o(),0===input.mouse[LEFT]&&l())}function drawButton(e,t,a,i,o,l,n,r=!1){mouseX>e&&mouseY>t&&mouseX<e+a&&mouseY<t+i&&(l(),0===input.mouse[LEFT]&&n()),r&&fill(200),stroke(0),rect(e,t,a,i),textSize(16),textAlign(CENTER,CENTER),textStyle(NORMAL),fill(0),noStroke(),text(o,e+a/2,t+i/2)}function selectState(e,t,a,i,o,l,n,r=!1){if(!o)return;const g=l(),m=o[mod(o.findIndex((e=>e.value===g))+1,o.length)].value;buttonState(e,t,a,i,(()=>{}),(()=>n(m)),r)}function drawSelect(e,t,a,i,o,l,n=!1){const r=l(),g=o.find((e=>e.value===r)).key;fill(250),drawButton(e,t,a,i,g,(()=>fill(240)),(()=>fill(230)),n)}function drawError(){game.errorAnim>0&&(fill(250,150,150),stroke(0),rect(width/2-300,200,600,50),noStroke(),fill(0),textAlign(CENTER,CENTER),textSize(16),text(game.error,width/2,225))}function drawLoading(){fill(250),strokeWeight(1),stroke(0),rect(width/2-100,height/2-60,200,120),noStroke(),fill(0),textAlign(CENTER,CENTER),textStyle(NORMAL),textSize(16),text("Loading...",width/2,height/2-40),tint(255),push(),translate(width/2,height/2),rotate(.01*millis()),image(images.small,-16,-16),stroke(0),noFill(),rect(-16,-16,32,32),pop(),textSize(10),text(game.loadMessage,width/2,height/2+40)}function drawCreateAccount(){fill(250),strokeWeight(1),stroke(0),rect(width/2-250,height/2-125,500,200),fill(0),noStroke(),textAlign(CENTER,CENTER),textStyle(BOLD),textSize(16),text("Chentris 2",width/2,height/2-90),textStyle(NORMAL),text("Welcome! Before continuing, please create a username.",width/2,height/2-50),text("Press enter to continue.",width/2,height/2+40),textSize(32),textWrap(CHAR),text(game.typedString+"_",width/2-250,height/2,500)}function drawPiece(e,t,a,i,o,l=255,n=!1){const r=getRotatedPiece(o,a),g=PIECES[o].color;n?noStroke():stroke(0),fill(g[0],g[1],g[2],l);for(let a=0;a<r.length;a++)for(let o=0;o<r[a].length;o++)1===r[a][o]&&rect(e+o*i,t+a*i,i,i)}function getIdealPos(e,t,a,i){if(t<=0)return[.5*a,.5*i];const o=ceil(sqrt(t));return[(e%o+.5)/o*a,(floor(e/o)+.5)/o*i]}function drawBoard(e,t,a,i,o){if(o>=0){fill(250),stroke(0),rect(-5*i,-10*i,10*i,20*i),stroke(200);for(let e=0;e<19;e++)line(-5*i+1,(-9+e)*i,5*i-1,(-9+e)*i);for(let e=0;e<9;e++)line((-4+e)*i,-10*i+1,(-4+e)*i,10*i-1)}if(o>=2){fill(250),stroke(0),rect(5*i,-10*i,.5*i,20*i),rect(-5.5*i,-10*i,.5*i,20*i);let t=0;for(let a=0;a<e.garbageQueue.length;a++){const o=e.garbageQueue[a],l=o.amount;t+=l,1===o.turns?fill(250,100+150*sin(.04*millis()),100):fill(200),rect(5*i,(10-t)*i,.5*i,l*i)}const a=Math.floor(getJuiceLevel(e.juice)),o=a+1,l=map(e.juice,getLevelJuice(a),getLevelJuice(o),0,1);stroke(0),fill(50+random(0,50),100+random(0,50),200+random(0,50)),rect(-5.5*i,(10-20*l)*i,.5*i,20*l*i);for(let e=0;e<a;e+=1)fill(50+random(0,50),100+random(0,50),200+random(0,50)),rect(-6*i,(9.5-.5*e)*i,.5*i,.5*i);for(let t=0;t<5;t++)drawPiece(6.5*i,(4*t-10)*i,0,i,e.bag[t+1]);-1!==e.hold&&drawPiece((-6-PIECES[e.hold].layout.length)*i,-10*i,0,i,e.hold,e.canHold?255:100)}if(o>=1&&(textAlign(TOP,CENTER),fill(0),noStroke(),textSize(16),textStyle(NORMAL),drawPiece((t.pieceX-5)*i,(t.pieceY-30)*i,t.pieceRotation,i,e.bag[0],a.dropping?100*(sin(.02*millis())+1)+50:255)),o>=3){const a=makeSubmove("drop",e,t);drawPiece((a.pieceX-5)*i,(a.pieceY-30)*i,t.pieceRotation,i,e.bag[0],100,!0)}if(o>=1)for(let t=0;t<40;t++)for(let a=0;a<10;a++){const o=10*t+a,l=e.tiles[o];if(l>=0){const e=PIECES[l].color;stroke(0),fill(e[0],e[1],e[2]),rect((-5+a)*i,(-30+t)*i,i,i)}}if(o>=4){const t=getCombos(e.combo),a=t.length;if(a>0){noStroke(),textAlign(RIGHT,CENTER),textStyle(NORMAL),textSize(16);let e=0,o=0;for(let a of t){if(o+=a.lines.count,o<=1)fill(30,50,150);else if(o<=2)fill(140,60,10);else if(o<=3)fill(80,30,140);else if(o<=4)fill(30,150,130);else if(o<=5)fill(140,130,10);else if(o<=6)fill(30,140,20);else if(o<=7)fill(140,30,50);else{let e=random(0,1)<.5,t=random(0,1)<.5,a=random(0,1)<.5&&!e&&!t;fill(e?250:50,t?250:50,a?250:50)}text(a.name,-7*i,(-3.5+e)*i),rect(-6.75*i,(-3.9+e)*i,.8*i,.8*i,5);let t=parseInt(a.original.substring(0,1));t&&(fill(250),t>=1&&rect(-6.65*i,(-3.8+e)*i,.25*i,.25*i,2),t>=2&&rect(-6.3*i,(-3.8+e)*i,.25*i,.25*i,2),t>=3&&rect(-6.65*i,(-3.45+e)*i,.25*i,.25*i,2),t>=4&&rect(-6.3*i,(-3.45+e)*i,.25*i,.25*i,2)),e+=1}if(textStyle(BOLD),textSize(12+4*a),o<=1)fill(30,50,150);else if(o<=2)fill(140,60,10);else if(o<=3)fill(80,30,140);else if(o<=4)fill(30,150,130);else if(o<=5)fill(140,130,10);else if(o<=6)fill(30,140,20);else if(o<=7)fill(140,30,50);else{let e=random(0,1)<.5,t=random(0,1)<.5,a=random(0,1)<.5&&!e&&!t;fill(e?250:50,t?250:50,a?250:50)}textAlign(RIGHT,BOTTOM),text(`x${a}`,-6*i,-5*i),textSize(16),textAlign(RIGHT,TOP),text(`${o} ${1===o?"line":"lines"}`,-6*i,-5*i)}textSize(16),textStyle(BOLD),textAlign(RIGHT,BOTTOM),noStroke(),fill(0),text(`${e.lines} line${1===e.lines?"":"s"}`,-6.5*i,8*i),text(`${e.juice} juice`,-6.5*i,9*i),text(`Level ${Math.floor(getJuiceLevel(e.juice))} (x${1+.2*Math.floor(getJuiceLevel(e.juice))})`,-6.5*i,10*i),textSize(300),textStyle(BOLD),textAlign(CENTER,CENTER),noStroke(),fill(0,100),e.finishingMoves>=0&&text(e.finishingMoves,0,0)}}function getKeyName(e){return 37===e?"left":39===e?"right":40===e?"down":38===e?"up":e===" ".charCodeAt(0)?"space":String.fromCharCode(e)}function drawState(){if(state.creatingNewAccount)return void drawCreateAccount();if(!socket.registered)return image(images.nathan,0,0,width,height),textSize(64),fill(255),void text("Something went wrong!",100,100);if(!game.inGame){stroke(0),fill(100,100,250),beginShape(),vertex(-100,10),vertex(420+3e3*game.mainMenuAnim,10),vertex(400+3e3*game.mainMenuAnim,85),vertex(-100,85),endShape(),fill(250,100,120),beginShape(),vertex(-100,10),vertex(400+1e3*game.mainMenuAnim,10),vertex(380+1e3*game.mainMenuAnim,85),vertex(-100,85),endShape(),fill(250),beginShape(),vertex(-100,10),vertex(380+500*game.mainMenuAnim,10),vertex(360+500*game.mainMenuAnim,85),vertex(-100,85),endShape(),fill(0),noStroke(),textSize(64),textStyle(BOLD),textAlign(LEFT,TOP),text("Chentris 2",20-400*game.mainMenuAnim,20),push(),translate(0,-600*game.mainMenuAnim),fill(250),stroke(0),textSize(32),beginShape(),vertex(width-10,15),vertex(width-50-textWidth(game.playerData.username),15),vertex(width-40-textWidth(game.playerData.username),70),vertex(width-10,70),endShape(CLOSE),noStroke(),fill(0),textAlign(RIGHT,TOP),text(game.playerData.username,width-20,20),textStyle(NORMAL),textSize(16),fill(200),text(`(#${game.playerData._id.substring(32)})`,width-20,50),stroke(0),fill(250),rect(width-100,80,90,95),rect(width-200,80,90,95),noStroke(),fill(0),textStyle(BOLD),textAlign(CENTER,TOP),textSize(10),text("Normal",width-155,88),text("Competitive",width-55,88),textSize(16),text(game.playerData.normalElo,width-155,100),text(game.playerData.compElo,width-55,100);const o=getRank(game.playerData.normalElo),l=getRank(game.playerData.compElo);image(o.icon,width-170,120),image(l.icon,width-70,120),textSize(12),textStyle(NORMAL),text(o.name,width-154,156),text(l.name,width-54,156),stroke(0),fill(250),rect(width-200,185,190,60),rect(width-200,255,190,30),fill(0),noStroke(),textStyle(BOLD),textAlign(LEFT,TOP),textSize(16);const n=floor(getLevel(game.playerData.xp));text(`Level ${n}`,width-190,190);const r=getXp(n),g=getXp(n+1),m=g-r,s=game.playerData.xp-r;textSize(12),textStyle(NORMAL),text(`${s.toLocaleString()} / ${m.toLocaleString()}`,width-190,205),textAlign(LEFT,TOP),text(r.toLocaleString(),width-190,230),textAlign(RIGHT,TOP),text(g.toLocaleString(),width-20,230),stroke(200),fill(250),rect(width-190,217,170,10),stroke(0),fill(50+250*sqrt(s/m),50,50+250*sqrt(1-s/m)),rect(width-190,217,s/m*170,10),stroke(0),fill(50+random(0,50),100+random(0,50),200+random(0,50)),rect(width-30,265,10,10),textAlign(RIGHT,CENTER),textSize(16),noStroke(),fill(0),text(game.playerData.juice.toLocaleString(),width-35,271),pop(),push(),translate(300*game.mainMenuAnim,0),textAlign(RIGHT,TOP),textSize(16);let c=0;for(let d=0;d<RANKS.length;d++){let h=RANKS[d];image(h.icon,width-40,height-40-40*d),textStyle(BOLD),text(h.name,width-45,height-40-40*d),textStyle(NORMAL),h.elo<1e9?text(c+" - "+(h.elo-1),width-45,height-20-40*d):text(c+"+",width-45,height-20-40*d),c=h.elo}pop(),textAlign(LEFT,CENTER),textSize(24),textStyle(BOLD);for(let u=0;u<game.menu.length;u++){const f=game.menu[u],p=1e3*pow(2,u)*game.menuAnim,S=2e3*pow(2,u)*game.menuAnim;stroke(0),fill(230),beginShape(),vertex(-100,100+50*u),vertex(310-S-10*u+20*game.menuButtonAnims[u],100+50*u),vertex(300-S-10*u+20*game.menuButtonAnims[u],140+50*u),vertex(-100,140+50*u),endShape(),fill(255),beginShape(),vertex(-100,100+50*u),vertex(300-p-10*u+10*game.menuButtonAnims[u],100+50*u),vertex(290-p-10*u+10*game.menuButtonAnims[u],140+50*u),vertex(-100,140+50*u),endShape(),noStroke(),fill(0),text(f.name,20-p,122+50*u)}if(state.joiningMatch){stroke(0),fill(250),rect(width/2-200,height/2-50,400,100),fill(0),noStroke(),textSize(16),textStyle(BOLD),textAlign(CENTER,TOP),text("Enter Join Code",width/2,height/2-40),textSize(32);for(let D=0;D<9;D++){const x=380/9*(D-4);rect(width/2-x-10,height/2+40,20,2);const y=game.typedString.charAt(D);y&&text(y,width/2+x,height/2)}fill(250,120,100),drawButton(width/2+160,height/2-50,40,20,"x",(()=>fill(230,100,80)),(()=>fill(220,90,70)))}return void(state.inSettings&&(stroke(0),fill(250),rect(width/2-500,height/2-300,1e3,600),line(width/2,height/2-300,width/2,height/2+300),fill(250,120,100),drawButton(width/2+460,height/2-300,40,20,"x",(()=>fill(230,100,80)),(()=>fill(220,90,70))),textSize(24),textStyle(BOLD),textAlign(LEFT,TOP),text("Settings",width/2-490,height/2-290),text("Controls",width/2+10,height/2-290),textStyle(NORMAL),textAlign(LEFT,TOP),textSize(16),text("Move Left",width/2+10,height/2-250),text("Move Right",width/2+10,height/2-220),text("Soft Drop",width/2+10,height/2-190),text("Hard Drop",width/2+10,height/2-160),text("Rotate Left",width/2+10,height/2-130),text("Rotate Right",width/2+10,height/2-100),text("Rotate 180",width/2+10,height/2-70),text("Hold",width/2+10,height/2-40),fill(250),drawButton(width/2+140,height/2-250,100,20,getKeyName(settings["controls.left"]),(()=>fill(230)),(()=>fill(210))),fill(250),drawButton(width/2+140,height/2-220,100,20,getKeyName(settings["controls.right"]),(()=>fill(230)),(()=>fill(210))),fill(250),drawButton(width/2+140,height/2-190,100,20,getKeyName(settings["controls.down"]),(()=>fill(230)),(()=>fill(210))),fill(250),drawButton(width/2+140,height/2-160,100,20,getKeyName(settings["controls.drop"]),(()=>fill(230)),(()=>fill(210))),fill(250),drawButton(width/2+140,height/2-130,100,20,getKeyName(settings["controls.rotateLeft"]),(()=>fill(230)),(()=>fill(210))),fill(250),drawButton(width/2+140,height/2-100,100,20,getKeyName(settings["controls.rotateRight"]),(()=>fill(230)),(()=>fill(210))),fill(250),drawButton(width/2+140,height/2-70,100,20,getKeyName(settings["controls.rotate180"]),(()=>fill(230)),(()=>fill(210))),fill(250),drawButton(width/2+140,height/2-40,100,20,getKeyName(settings["controls.hold"]),(()=>fill(230)),(()=>fill(210))),fill(250),drawButton(width/2+340,height/2+260,150,30,"Reset Settings",(()=>fill(230)),(()=>fill(210))),game.awaitingKeypress&&(fill(0),textSize(16),noStroke(),textAlign(LEFT,TOP),textStyle(BOLD),text("Press any key to set keybind. Press ESC to cancel.",width/2+10,height/2))))}if(game.gameData.match.over&&game.gameData.match.matchOverDelay>=20){fill(0),noStroke(),textStyle(BOLD),textAlign(LEFT,TOP),textSize(32),text("Match Results",20,20),textSize(24);const w=game.gameData.match.data[game.gameData.match.results.winner];text("Winner: "+(w?w.username:"Nobody"),20,60),text(`Returning to lobby in ${floor((400-game.gameData.match.matchOverDelay)/20)}...`,20,height-50);const b=game.gameData.match.results.rewards[game.playerData._id],k=clamp(game.gameData.match.matchOverDelay-20,0,80)/80,A=floor(game.playerData.xp+k*b.xp),v=floor((game.gameData.match.rules.competitive?game.playerData.compElo:game.playerData.normalElo)+k*b.elo),O=floor(game.playerData.juice+k*b.juice);text(`XP: +${floor(k*b.xp)}`,20,height-200),text(`JUICE: +${floor(k*b.juice)}`,20,height-170),text(`ELO: ${b.elo>0?"+":""}${round(k*b.elo)}`,20,height-140),fill(0),textAlign(LEFT,BOTTOM),textSize(24);const E=floor(getLevel(A));text(`Level ${E}`,40,200);const R=getXp(E),T=getXp(E+1),L=T-R,N=A-R;fill(0),textSize(20),textStyle(NORMAL),text(`${N.toLocaleString()} / ${L.toLocaleString()}`,40,220),textAlign(LEFT,TOP),text(R.toLocaleString(),40,245),textAlign(RIGHT,TOP),text(T.toLocaleString(),width-40,245),stroke(200),fill(250),rect(40,220,width-80,20),stroke(0),fill(50+250*sqrt(N/L),50,50+250*sqrt(1-N/L)),rect(40,220,(width-80)*(N/L),20),fill(50+random(0,50),100+random(0,50),200+random(0,50)),rect(300,310,20,20),noStroke(),fill(0),textAlign(RIGHT,CENTER),textSize(24),text(O.toLocaleString(),290,320);const C=getRank(v);return text(v,590,320),image(C.icon,600,300,40,40),textSize(16),void text(C.name,590,340)}push();let e=0,t=0;if(game.localData.board.lost){const _=50*game.localData.deadAnim;t=_**2-20*_,e=-_*log(_+1)}translate(game.boardOrigin[0]+e,game.boardOrigin[1]+t),rotate(game.boardRotation+.002*e),scale(game.boardScale),translate(game.boardTranslation[0],game.boardTranslation[1]),drawBoard(game.localData.board,game.localData.state,game.localData.timers,SQUARE_SIZE,4),game.gameData.match.playing?(textSize(20),textAlign(CENTER,TOP),textStyle(BOLD),fill(0),noStroke(),text(`${game.gameData.match.kills[game.playerData._id]} KO${1===game.gameData.match.kills[game.playerData._id]?"":"s"}`,0,11*SQUARE_SIZE)):(textStyle(BOLD),textSize(32),textAlign(CENTER,CENTER),fill(0,100),noStroke(),text("Practice",0,0)),pop(),textStyle(BOLD),textAlign(CENTER,CENTER),noStroke();for(let M of game.boardNotifications)textSize(16+100*sqrt(M.time)),fill(0,300*(1-M.time)),text(M.text,game.boardOrigin[0],game.boardOrigin[1]);if(game.gameData.match.playing){fill(0),textAlign(LEFT,TOP),textSize(16),textStyle(BOLD);const B=game.gameData.match.players.length,z=game.gameData.match.players.filter((e=>e!==game.playerData._id)),I=game.gameData.match.players.filter((e=>!game.gameData.match.boards[e].lost));for(let F of z){const P=game.localData.boardAnims[F];P[2]>5||(push(),translate(P[0],P[1]),rotate(-50*P[2]*log(50*P[2]+1)*.002),drawBoard(game.gameData.match.boards[F],game.gameData.match.states[F].state||defaultSubmoveState(),game.gameData.match.states[F].timers||{fall:0,dropping:!1,shortDrop:0,longDrop:0},game.localData.boardSizes[F],B>=25?0:B>=17?1:B>=10?2:B>=5?3:B<=2?4:3),noStroke(),fill(0),textSize(16),textAlign(CENTER,BOTTOM),textStyle(BOLD),text(`${game.gameData.match.data[F].username} (${game.gameData.match.kills[F]} KO${1===game.gameData.match.kills[F]?"":"s"})`,0,-11*game.localData.boardSizes[F]),pop())}if(I.length>2)for(let G=0;G<5;G+=1)stroke(0),fill(game.localData.attackOption===G?0:250),rect(width/2-250+100*G,height-35,95,20),rect(width/2-250+100*G,height-40,30,30),noStroke(),fill(game.localData.attackOption===G?250:0),textAlign(CENTER,CENTER),textStyle(BOLD),text(G+1,width/2-235+100*G,height-25),textStyle(NORMAL),textAlign(LEFT,CENTER),0===G?text("random",width/2-216+100*G,height-24):1===G?text("kills",width/2-216+100*G,height-24):2===G?text("revenge",width/2-216+100*G,height-24):3===G?text("winners",width/2-216+100*G,height-24):4===G&&text("losers",width/2-216+100*G,height-24);game.localData.board.lost&&(textSize(32),textStyle(BOLD),textAlign(CENTER,CENTER),fill(0),noStroke(),game.gameData.match.results.winner===game.playerData._id?text("You win!",game.boardOrigin[0],game.boardOrigin[1]):text("You are eliminated!",game.boardOrigin[0],game.boardOrigin[1]))}else{push(),translate(400*-game.matchAnim,0),fill(250),stroke(0),rect(10,30,200,250),rect(10,310,200,200),fill(0),noStroke(),textSize(16),textStyle(BOLD),textAlign(CENTER,BOTTOM),text("Match",110,25),text("Rules",110,304),textAlign(LEFT,TOP),text("Code",20,40),textSize(32);for(let $=0;$<9;$++)text(game.gameData.match.joinCode[$],20+20*$,60);function a(e){return game.gameData.match.options[e]}function i(e){return game.gameData.match.rules[e]}stroke(0),fill(120,100,250),drawButton(20,95,180,30,"Copy Link",(()=>fill(100,80,230)),(()=>{}),!game.gameData.match.options.allowJoining),fill(250,120,100),drawButton(20,130,180,30,"Leave Match",(()=>fill(230,100,80)),(()=>{})),textAlign(LEFT,TOP),fill(0),text("Allow joining",20,200),text("Public",20,225),text("Ranked",20,250),drawSelect(150,200,50,20,ON_OR_OFF,(()=>a("allowJoining")),!1),drawSelect(150,225,50,20,ON_OR_OFF,(()=>a("public")),!1),drawSelect(150,250,50,20,ON_OR_OFF,(()=>a("ranked")),!1),textAlign(LEFT,TOP),text("Competitive",20,325),text("Initial Speed",20,350),text("Resend Garbage",20,375),text("Forgiving Combos",20,400),text("Garbage Turns",20,425),text("Garbage Defense",20,450),drawSelect(150,325,50,20,ON_OR_OFF,(()=>i("competitive")),!1),drawSelect(150,350,50,20,[{key:"slow",value:80},{key:"medium",value:160},{key:"fast",value:320},{key:"very fast",value:640}],(()=>i("initialSpeed")),i("competitive")),drawSelect(150,375,50,20,ON_OR_OFF,(()=>i("resendGarbage")),i("competitive")),drawSelect(150,400,50,20,ON_OR_OFF,(()=>i("forgivingCombos")),i("competitive")),drawSelect(150,425,50,20,[{key:"one",value:1},{key:"two",value:2},{key:"three",value:3}],(()=>i("garbageTurns")),i("competitive")),drawSelect(150,450,50,20,ON_OR_OFF,(()=>i("garbageDefense")),i("competitive")),pop();for(let j=0;j<game.gameData.match.players.length;j++){const K=game.gameData.match.players[j],H=game.gameData.match.data[K];if(!H)continue;const Y=45*j;fill(250),stroke(0),rect(width-210,10+Y,200,40),rect(width-45,15+Y,30,30),fill(0),noStroke(),textAlign(RIGHT,TOP),textStyle(BOLD),textSize(16),text(H.username,width-50,15+Y);const J=game.gameData.match.rules.competitive?H.compElo:H.normalElo,U=getRank(J);textStyle(NORMAL),text(J,width-70,33+Y),textStyle(BOLD),textSize(12),textAlign(CENTER,CENTER),text(getLevel(H.xp),width-30,30+Y),image(U.icon,width-65,32+Y,14,14),stroke(0),noFill(),rect(width-65,32+Y,14,14),H._id===game.playerData._id&&(fill(250),triangle(width-250,20+Y,width-250,40+Y,width-230,30+Y)),H._id===game.gameData.match.leader&&(fill(220,160,100),beginShape(),vertex(width-200,20+Y),vertex(width-195,30+Y),vertex(width-190,20+Y),vertex(width-185,30+Y),vertex(width-180,20+Y),vertex(width-180,40+Y),vertex(width-200,40+Y),endShape(CLOSE)),game.gameData.match.ready[K]?fill(100,250,120):fill(250,120,100),rect(width-220,10+Y,10,40)}game.localData.ready?fill(100,250,120):fill(250,120,100),textSize(12),textAlign(RIGHT,CENTER),textStyle(BOLD),noStroke(),text(`You are ${game.localData.ready?"READY":"NOT READY"}.`,width-220,height/2)}}function draw(){if(update(),updateInput(),game.loading)return drawLoading(),void drawError();background(250),drawState(),drawError()}
//# sourceMappingURL=index.4958a78b.js.map
